<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Study Hub</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="icon2_192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="icon2_512x512.png" sizes="512x512">
    <link rel="apple-touch-icon" href="icon2_180x180.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container" data-theme="light">
        <header class="header">
            <div class="header-left">
                <button id="menuToggle" class="icon-button menu-toggle-btn"><i class="fas fa-bars"></i></button>
                <h1 class="app-title">My Study Hub</h1>
            </div>
            <div class="header-right">
                <button id="darkModeToggle" class="icon-button"><i class="fas fa-moon"></i></button>
                <button id="calculatorButton" class="icon-button"><i class="fas fa-calculator"></i></button>
            </div>
        </header>

        <div class="main-layout">
            <nav id="sidebar" class="sidebar">
                <button class="nav-button active" data-target="notesSection">
                    <i class="fas fa-book"></i>
                    <span>Notes</span>
                </button>
                <button class="nav-button" data-target="todoSection">
                    <i class="fas fa-list-check"></i>
                    <span>To-Do</span>
                </button>
                <button class="nav-button" data-target="timetableSection">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Timetable</span>
                </button>
                <button class="nav-button" data-target="homeworkSection">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Homework</span>
                </button>
                <button class="nav-button" data-target="linksSection">
                    <i class="fas fa-link"></i>
                    <span>Links</span>
                </button>
                <button class="nav-button" data-target="pomodoroSection">
                    <i class="fas fa-clock"></i>
                    <span>Pomodoro</span>
                </button>
               
                <button class="nav-button" data-target="pdfViewerSection">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF Viewer</span>
                </button>
                <button class="nav-button" data-target="backupRestoreSection">
                    <i class="fas fa-cloud-arrow-up"></i>
                    <span>Backup</span>
                </button>
            </nav>

            <main class="content">
                <section id="notesSection" class="section active">
                    <div class="section-header">
                        <h2>üìö Notes Section</h2>
                        <button id="createNewNoteBtn" class="add-new-btn"><i class="fas fa-plus"></i> New Note</button>
                    </div>
                    <div class="notes-container">
                        <h3>Your Notes</h3>
                        <ul id="notesList" class="styled-list notes-list">
                            <p class="placeholder-text">No notes yet. Click 'New Note' to create one!</p>
                        </ul>
                        <h3 class="mt-30">Current Note: <span id="currentNoteTitleDisplay">Not Loaded</span></h3>
                        <div id="editor"></div>
                        <div class="note-actions-bar mt-15">
                            <button id="saveCurrentNoteBtn" class="action-btn save-btn"><i class="fas fa-save"></i> Save Note</button>
                            
                            <button id="downloadNotePdfBtn" class="action-btn"><i class="fas fa-download"></i> Download as PDF</button>
                        </div>
                        <p class="small-text">Notes are saved in your browser's local storage.</p>
                        <h3 class="mt-30">PDF Notes (Local Storage - Limited Capacity)</h3>
                        <div class="pdf-upload-area">
                            <p>Upload your PDF notes here:</p>
                            
                            <div class="pdf-upload-controls">
                                <select id="pdfSubjectSelect" class="text-input">
                                    <option value="">Select Subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="English">English</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="customSubjectInput" placeholder="Enter custom subject" class="text-input" style="display: none;">
                                <input type="file" id="pdfUploadInput" accept=".pdf">
                                <button id="uploadPdfBtn" class="action-btn"><i class="fas fa-upload"></i> Upload PDF</button>
                            </div>
                            <p class="small-text">Warning: Storing large PDFs in local storage is not recommended.</p>
                            <div id="pdfList" class="pdf-list"></div>
                        </div>
                    </div>
                </section>

               
                <section id="pdfViewerSection" class="section">
                    <div class="section-header">
                        <h2>üìÑ PDF Viewer</h2>
                        <div class="pdf-viewer-controls">
                            <select id="subjectFilterSelect" class="text-input">
                                <option value="">All Subjects</option>
                            </select>
                        </div>
                    </div>
                    <div class="pdf-viewer-container">
                        <div id="pdfSubjectCategories" class="pdf-categories">
                            <p class="placeholder-text">No PDFs uploaded yet. Upload PDFs from the Notes section to view them here!</p>
                        </div>
                        <div id="pdfViewerDisplay" class="pdf-viewer-display">
                            <p class="placeholder-text">Select a PDF to view it here</p>
                        </div>
                    </div>
                </section>

                <section id="todoSection" class="section">
                    <div class="section-header">
                        <h2>üìù To-Do List</h2>
                    </div>
                    <div class="todo-input-group">
                        <input type="text" id="todoInput" placeholder="Enter new task..." class="text-input">
                        <button id="addTodoItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <ul id="todoList" class="styled-list"></ul>
                    <p class="small-text">To-Do items are saved in your browser's local storage.</p>
                </section>

                <section id="timetableSection" class="section">
                    <div class="section-header">
                        <h2>üìÖ Editable Timetable</h2>
                    </div>
                    <div class="timetable-grid">
                        <p class="small-text">Timetable data is saved in your browser's local storage.</p>
                        <table class="timetable-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button id="saveTimetableBtn" class="action-btn save-btn mt-20"><i class="fas fa-save"></i> Save Timetable</button>
                    </div>
                </section>

                <section id="homeworkSection" class="section">
                    <div class="section-header">
                        <h2>üìö Homework</h2>
                    </div>
                    <div class="homework-input-group">
                        <input type="text" id="homeworkInput" placeholder="e.g., Math Ch 3 exercises" class="text-input">
                        <input type="date" id="homeworkDueDate" class="text-input">
                        <button id="addHomeworkItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <ul id="homeworkList" class="styled-list"></ul>
                    <p class="small-text">Homework items are saved in your browser's local storage.</p>
                </section>

                <section id="linksSection" class="section">
                    <div class="section-header">
                        <h2>üîó Links Section</h2>
                    </div>
                    <div class="link-input-group">
                        <input type="text" id="linkNameInput" placeholder="Link Name" class="text-input">
                        <input type="url" id="linkUrlInput" placeholder="https://example.com" class="text-input">
                        <button id="addLinkItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <ul id="linksList" class="styled-list"></ul>
                    <p class="small-text">Links are saved in your browser's local storage.</p>
                </section>

                <section id="pomodoroSection" class="section">
                    <div class="section-header">
                        <h2>‚è∞ Pomodoro Timer</h2>
                    </div>
                    <div class="timer-display-container">
                        <div class="timer-display" id="pomodoroTimerDisplay">25:00</div>
                        <p class="timer-status" id="pomodoroStatus">Work Session</p>
                    </div>
                    <div class="timer-controls">
                        <button id="startTimerBtn" class="action-btn start-btn"><i class="fas fa-play"></i> Start</button>
                        <button id="pauseTimerBtn" class="action-btn pause-btn"><i class="fas fa-pause"></i> Pause</button>
                        <button id="resetTimerBtn" class="action-btn reset-btn"><i class="fas fa-redo-alt"></i> Reset</button>
                    </div>
                    <div class="timer-settings">
                        <div class="input-group">
                            <label for="workTime">Work (min):</label>
                            <input type="number" id="workTime" value="25" min="1" class="time-input">
                        </div>
                        <div class="input-group">
                            <label for="breakTime">Break (min):</label>
                            <input type="number" id="breakTime" value="5" min="1" class="time-input">
                        </div>
                    </div>
                </section>

                <section id="backupRestoreSection" class="section">
                    <div class="section-header">
                        <h2>‚òÅÔ∏è Backup & Restore</h2>
                    </div>
                    <div class="backup-restore-area">
                        <p class="small-text">Export all your data (notes, to-dos, timetable, etc.) to a JSON file.</p>
                        <button id="exportDataBtn" class="action-btn"><i class="fas fa-download"></i> Export Data</button>
                        <div class="import-section mt-15">
                            <p class="small-text">Import data from a previously exported JSON backup file.</p>
                            <input type="file" id="importFileInput" accept=".json">
                            <button id="importDataBtn" class="action-btn save-btn"><i class="fas fa-upload"></i> Import Data</button>
                            <p class="small-text import-warning">Warning: Importing data will overwrite your current data. Be careful!</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <div id="calculatorModal" class="modal">
            <div class="modal-content calculator-content">
                <span class="close-button" id="closeCalculatorBtn">&times;</span>
                <h3>Calculator</h3>
                <div class="calculator">
                    <input type="text" class="calculator-display" id="calcDisplay" value="0" readonly>
                    <div class="calculator-buttons">
                        <button class="btn clear" data-action="clear">C</button>
                        <button class="btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>
                        <button class="btn operator" data-value="%">%</button>
                        <button class="btn operator" data-value="/">/</button>

                        <button class="btn number" data-value="7">7</button>
                        <button class="btn number" data-value="8">8</button>
                        <button class="btn number" data-value="9">9</button>
                        <button class="btn operator" data-value="*">x</button>

                        <button class="btn number" data-value="4">4</button>
                        <button class="btn number" data-value="5">5</button>
                        <button class="btn number" data-value="6">6</button>
                        <button class="btn operator" data-value="-">-</button>

                        <button class="btn number" data-value="1">1</button>
                        <button class="btn number" data-value="2">2</button>
                        <button class="btn number" data-value="3">3</button>
                        <button class="btn operator" data-value="+">+</button>

                        <button class="btn number zero" data-value="0">0</button>
                        <button class="btn number" data-value=".">.</button>
                        <button class="btn equals" data-action="equals">=</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.section');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const calculatorButton = document.getElementById('calculatorButton');
            const calculatorModal = document.getElementById('calculatorModal');
            const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');

            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');

            // --- Utility Functions ---
            function generateUniqueId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            function reloadAllData() {
                allNotes = JSON.parse(localStorage.getItem('allNotes')) || [];
                todos = JSON.parse(localStorage.getItem('todos')) || [];
                homeworks = JSON.parse(localStorage.getItem('homeworks')) || [];
                links = JSON.parse(localStorage.getItem('links')) || [];
                pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                activeNoteId = localStorage.getItem('activeNoteId');

                renderNotesList();
                if (activeNoteId) {
                    loadNoteIntoEditor(activeNoteId);
                } else if (allNotes.length > 0) {
                    loadNoteIntoEditor(allNotes[0].id);
                } else {
                    editor.setContents([{ insert: 'Welcome to your Study Hub Notes! Click "New Note" to create one!' }]);
                    currentNoteTitleDisplay.textContent = 'Not Loaded';
                }

                renderPdfs();
                renderTodos();
                loadTimetable();
                renderHomeworks();
                renderLinks();
                loadDarkModePreference();
        
                renderPdfViewer();
                alert('All data reloaded!');
            }

            // --- Dark Mode Functionality ---
            function loadDarkModePreference() {
                const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            loadDarkModePreference();

            // --- Navigation Functionality ---
            function showSection(targetId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');

                navButtons.forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector(`[data-target="${targetId}"]`).classList.add('active');

                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            }

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    showSection(targetId);
                });
            });

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // --- Calculator Functionality ---
            calculatorButton.addEventListener('click', () => {
                calculatorModal.style.display = 'flex';
            });

            closeCalculatorBtn.addEventListener('click', () => {
                calculatorModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === calculatorModal) {
                    calculatorModal.style.display = 'none';
                }
            });

            const calcDisplay = document.getElementById('calcDisplay');
            const calcButtons = document.querySelectorAll('.calculator-buttons .btn');
            let currentInput = '0';
            let operator = null;
            let previousInput = null;
            let waitingForOperand = false;

            function updateDisplay() {
                calcDisplay.value = currentInput;
            }

            function inputNumber(num) {
                if (waitingForOperand) {
                    currentInput = num;
                    waitingForOperand = false;
                } else {
                    currentInput = currentInput === '0' ? num : currentInput + num;
                }
                updateDisplay();
            }

            function inputOperator(nextOperator) {
                const inputValue = parseFloat(currentInput);

                if (previousInput === null) {
                    previousInput = inputValue;
                } else if (operator) {
                    const currentValue = previousInput || 0;
                    const newValue = calculate(currentValue, inputValue, operator);

                    currentInput = String(newValue);
                    previousInput = newValue;
                    updateDisplay();
                }

                waitingForOperand = true;
                operator = nextOperator;
            }

            function calculate(firstOperand, secondOperand, operator) {
                switch (operator) {
                    case '+': return firstOperand + secondOperand;
                    case '-': return firstOperand - secondOperand;
                    case '*': return firstOperand * secondOperand;
                    case '/': return firstOperand / secondOperand;
                    case '%': return firstOperand % secondOperand;
                    default: return secondOperand;
                }
            }

            calcButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-action');
                    const value = button.getAttribute('data-value');

                    if (button.classList.contains('number')) {
                        inputNumber(value);
                    } else if (button.classList.contains('operator')) {
                        inputOperator(value);
                    } else if (action === 'equals') {
                        if (operator && previousInput !== null && !waitingForOperand) {
                            const inputValue = parseFloat(currentInput);
                            const newValue = calculate(previousInput, inputValue, operator);
                            currentInput = String(newValue);
                            previousInput = null;
                            operator = null;
                            waitingForOperand = true;
                            updateDisplay();
                        }
                    } else if (action === 'clear') {
                        currentInput = '0';
                        previousInput = null;
                        operator = null;
                        waitingForOperand = false;
                        updateDisplay();
                    } else if (action === 'backspace') {
                        if (currentInput.length > 1) {
                            currentInput = currentInput.slice(0, -1);
                        } else {
                            currentInput = '0';
                        }
                        updateDisplay();
                    }
                });
            });

            // --- Notes Functionality ---
            let allNotes = JSON.parse(localStorage.getItem('allNotes')) || [];
            let activeNoteId = localStorage.getItem('activeNoteId');

            const notesList = document.getElementById('notesList');
            const createNewNoteBtn = document.getElementById('createNewNoteBtn');
            const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
            const currentNoteTitleDisplay = document.getElementById('currentNoteTitleDisplay');
            // <CHANGE> Added download PDF button reference
            const downloadNotePdfBtn = document.getElementById('downloadNotePdfBtn');

            const editor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            function renderNotesList() {
                if (allNotes.length === 0) {
                    notesList.innerHTML = '<p class="placeholder-text">No notes yet. Click \'New Note\' to create one!</p>';
                    return;
                }

                notesList.innerHTML = '';
                allNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'note-item';
                    if (note.id === activeNoteId) {
                        li.classList.add('active-note');
                    }

                    li.innerHTML = `
                        <span class="note-title">${note.title}</span>
                        <div class="note-actions">
                            <button class="icon-button edit-btn" data-note-id="${note.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="icon-button delete-btn" data-note-id="${note.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    `;

                    notesList.appendChild(li);
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const noteId = btn.getAttribute('data-note-id');
                        loadNoteIntoEditor(noteId);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const noteId = btn.getAttribute('data-note-id');
                        deleteNote(noteId);
                    });
                });
            }

            function loadNoteIntoEditor(noteId) {
                const note = allNotes.find(n => n.id === noteId);
                if (note) {
                    try {
                        const delta = JSON.parse(note.content);
                        editor.setContents(delta);
                    } catch (error) {
                        editor.setText(note.content || '');
                    }
                    activeNoteId = noteId;
                    localStorage.setItem('activeNoteId', activeNoteId);
                    currentNoteTitleDisplay.textContent = note.title;
                    renderNotesList();
                }
            }

            function deleteNote(noteId) {
                if (confirm('Are you sure you want to delete this note?')) {
                    allNotes = allNotes.filter(note => note.id !== noteId);
                    localStorage.setItem('allNotes', JSON.stringify(allNotes));

                    if (activeNoteId === noteId) {
                        if (allNotes.length > 0) {
                            loadNoteIntoEditor(allNotes[0].id);
                        } else {
                            activeNoteId = null;
                            localStorage.removeItem('activeNoteId');
                            editor.setContents([{ insert: 'Welcome to your Study Hub Notes! Click "New Note" to create one!' }]);
                            currentNoteTitleDisplay.textContent = 'Not Loaded';
                        }
                    }

                    renderNotesList();
                }
            }

            createNewNoteBtn.addEventListener('click', () => {
                const title = prompt('Enter note title:');
                if (title && title.trim()) {
                    const newNote = {
                        id: generateUniqueId(),
                        title: title.trim(),
                        content: JSON.stringify([{ insert: '' }]),
                        createdAt: new Date().toISOString()
                    };

                    allNotes.push(newNote);
                    localStorage.setItem('allNotes', JSON.stringify(allNotes));
                    loadNoteIntoEditor(newNote.id);
                    renderNotesList();
                }
            });

            saveCurrentNoteBtn.addEventListener('click', () => {
                if (activeNoteId) {
                    const note = allNotes.find(n => n.id === activeNoteId);
                    if (note) {
                        note.content = JSON.stringify(editor.getContents());
                        note.updatedAt = new Date().toISOString();
                        localStorage.setItem('allNotes', JSON.stringify(allNotes));
                        alert('Note saved successfully!');
                    }
                } else {
                    alert('No active note to save. Please create a new note first.');
                }
            });

            // <CHANGE> Added PDF download functionality for notes
            downloadNotePdfBtn.addEventListener('click', () => {
                if (activeNoteId) {
                    const note = allNotes.find(n => n.id === activeNoteId);
                    if (note) {
                        downloadNoteAsPdf(note);
                    }
                } else {
                    alert('No active note to download. Please select a note first.');
                }
            });

           function downloadNoteAsPdf(note) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Define page dimensions and margins
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = doc.internal.pageSize.getHeight();
    const margin = 10;
    const contentWidth = pdfWidth - 2 * margin;

    const noteContentElement = document.getElementById('editor');

    // Add a title and date to the first page
    doc.setFontSize(20);
    doc.text(note.title, margin, margin + 5);
    doc.setFontSize(10);
    const createdDate = new Date(note.createdAt).toLocaleDateString();
    doc.text(`Created: ${createdDate}`, margin, margin + 15);

    // --- The change is in the 'scale' option below ---
    html2canvas(noteContentElement, { 
        scale: 3, // Set a higher scale for better resolution
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg');
        const imgWidth = contentWidth;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = margin + 20;

        // Add the first page
        doc.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - position);
        
        // Loop to add new pages if content is longer
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight + margin;
            doc.addPage();
            doc.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
        }

        // Save the PDF
        doc.save(`${note.title}.pdf`);
    });
}

            // --- PDF Upload Functionality ---
            let pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
            const pdfUploadInput = document.getElementById('pdfUploadInput');
            const uploadPdfBtn = document.getElementById('uploadPdfBtn');
            const pdfList = document.getElementById('pdfList');
           
            const pdfSubjectSelect = document.getElementById('pdfSubjectSelect');
            const customSubjectInput = document.getElementById('customSubjectInput');

           
            pdfSubjectSelect.addEventListener('change', () => {
                if (pdfSubjectSelect.value === 'Other') {
                    customSubjectInput.style.display = 'block';
                    customSubjectInput.required = true;
                } else {
                    customSubjectInput.style.display = 'none';
                    customSubjectInput.required = false;
                    customSubjectInput.value = '';
                }
            });

            uploadPdfBtn.addEventListener('click', () => {
                const file = pdfUploadInput.files[0];
                let subject = pdfSubjectSelect.value;
                
                if (!file) {
                    alert('Please select a PDF file to upload.');
                    return;
                }

                if (!subject) {
                    alert('Please select a subject for the PDF.');
                    return;
                }

                if (subject === 'Other') {
                    subject = customSubjectInput.value.trim();
                    if (!subject) {
                        alert('Please enter a custom subject name.');
                        return;
                    }
                }

                if (file.type !== 'application/pdf') {
                    alert('Please select a valid PDF file.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const pdfData = {
                        id: generateUniqueId(),
                        name: file.name,
                        subject: subject,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    };

                    pdfs.push(pdfData);
                    localStorage.setItem('pdfs', JSON.stringify(pdfs));
                    renderPdfs();
                    
                    renderPdfViewer();
                    pdfUploadInput.value = '';
                    pdfSubjectSelect.value = '';
                    customSubjectInput.style.display = 'none';
                    customSubjectInput.value = '';
                    alert('PDF uploaded successfully!');
                };
                reader.readAsDataURL(file);
            });

            function renderPdfs() {
                if (pdfs.length === 0) {
                    pdfList.innerHTML = '<p class="placeholder-text">No PDFs uploaded yet.</p>';
                    return;
                }

                pdfList.innerHTML = '';
                pdfs.forEach(pdf => {
                    const pdfItem = document.createElement('div');
                    pdfItem.className = 'pdf-item';
                    pdfItem.innerHTML = `
                        <div class="pdf-info">
                            <strong>${pdf.name}</strong>
                            <span class="pdf-subject">${pdf.subject}</span>
                            <small>Uploaded: ${new Date(pdf.uploadedAt).toLocaleDateString()}</small>
                        </div>
                        <div class="pdf-actions">
                            <button class="action-btn small-btn view-pdf-btn" data-pdf-id="${pdf.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="delete-btn small-btn" data-pdf-id="${pdf.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    pdfList.appendChild(pdfItem);
                });

                document.querySelectorAll('.view-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pdfId = btn.getAttribute('data-pdf-id');
                        const pdf = pdfs.find(p => p.id === pdfId);
                        if (pdf) {
                            window.open(pdf.data, '_blank');
                        }
                    });
                });

                document.querySelectorAll('.pdf-item .delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pdfId = btn.getAttribute('data-pdf-id');
                        if (confirm('Are you sure you want to delete this PDF?')) {
                            pdfs = pdfs.filter(pdf => pdf.id !== pdfId);
                            localStorage.setItem('pdfs', JSON.stringify(pdfs));
                            renderPdfs();
                          
                            renderPdfViewer();
                        }
                    });
                });
            }

        
            const pdfSubjectCategories = document.getElementById('pdfSubjectCategories');
            const pdfViewerDisplay = document.getElementById('pdfViewerDisplay');
            const subjectFilterSelect = document.getElementById('subjectFilterSelect');

            function renderPdfViewer() {
                if (pdfs.length === 0) {
                    pdfSubjectCategories.innerHTML = '<p class="placeholder-text">No PDFs uploaded yet. Upload PDFs from the Notes section to view them here!</p>';
                    updateSubjectFilter();
                    return;
                }

                // Group PDFs by subject
                const pdfsBySubject = {};
                pdfs.forEach(pdf => {
                    if (!pdfsBySubject[pdf.subject]) {
                        pdfsBySubject[pdf.subject] = [];
                    }
                    pdfsBySubject[pdf.subject].push(pdf);
                });

                // Render categories
                pdfSubjectCategories.innerHTML = '';
                Object.keys(pdfsBySubject).forEach(subject => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'pdf-category';
                    categoryDiv.innerHTML = `
                        <h3 class="category-title">${subject} (${pdfsBySubject[subject].length})</h3>
                        <div class="category-pdfs">
                            ${pdfsBySubject[subject].map(pdf => `
                                <div class="pdf-card" data-pdf-id="${pdf.id}">
                                    <div class="pdf-card-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div class="pdf-card-info">
                                        <div class="pdf-card-name">${pdf.name}</div>
                                        <div class="pdf-card-date">${new Date(pdf.uploadedAt).toLocaleDateString()}</div>
                                    </div>
                                    <div class="pdf-card-actions">
                                        <button class="icon-button view-pdf-viewer-btn" data-pdf-id="${pdf.id}" title="View in viewer">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="icon-button open-pdf-btn" data-pdf-id="${pdf.id}" title="Open in new tab">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    pdfSubjectCategories.appendChild(categoryDiv);
                });

                // Add event listeners for PDF cards
                document.querySelectorAll('.view-pdf-viewer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pdfId = btn.getAttribute('data-pdf-id');
                        viewPdfInViewer(pdfId);
                    });
                });

                document.querySelectorAll('.open-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pdfId = btn.getAttribute('data-pdf-id');
                        const pdf = pdfs.find(p => p.id === pdfId);
                        if (pdf) {
                            window.open(pdf.data, '_blank');
                        }
                    });
                });

                updateSubjectFilter();
            }

            function updateSubjectFilter() {
                const subjects = [...new Set(pdfs.map(pdf => pdf.subject))];
                subjectFilterSelect.innerHTML = '<option value="">All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilterSelect.appendChild(option);
                });
            }

            function viewPdfInViewer(pdfId) {
                const pdf = pdfs.find(p => p.id === pdfId);
                if (pdf) {
                    pdfViewerDisplay.innerHTML = `
                        <div class="pdf-viewer-header">
                            <h3>${pdf.name}</h3>
                            <div class="pdf-viewer-actions">
                                <button class="action-btn" onclick="window.open('${pdf.data}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Open in New Tab
                                </button>
                                <button class="action-btn" onclick="downloadPdf('${pdf.id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <iframe src="${pdf.data}" width="100%" height="600px" style="border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
                    `;
                }
            }

            // Global function for downloading PDF
            window.downloadPdf = function(pdfId) {
                const pdf = pdfs.find(p => p.id === pdfId);
                if (pdf) {
                    const link = document.createElement('a');
                    link.href = pdf.data;
                    link.download = pdf.name;
                    link.click();
                }
            };

            subjectFilterSelect.addEventListener('change', () => {
                const selectedSubject = subjectFilterSelect.value;
                const categories = document.querySelectorAll('.pdf-category');
                
                categories.forEach(category => {
                    const categoryTitle = category.querySelector('.category-title').textContent;
                    if (selectedSubject === '' || categoryTitle.startsWith(selectedSubject)) {
                        category.style.display = 'block';
                    } else {
                        category.style.display = 'none';
                    }
                });
            });

            // --- To-Do List Functionality ---
            const todoInput = document.getElementById('todoInput');
            const addTodoItemBtn = document.getElementById('addTodoItemBtn');
            const todoList = document.getElementById('todoList');
            let todos = JSON.parse(localStorage.getItem('todos')) || [];

            function renderTodos() {
                if (todos.length === 0) {
                    todoList.innerHTML = '<p class="placeholder-text">No to-do items yet.</p>';
                    return;
                }

                todoList.innerHTML = '';
                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${todo.task}</span>
                        <div class="actions">
                            <button class="delete-todo-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    todoList.appendChild(li);
                });
            }

            addTodoItemBtn.addEventListener('click', () => {
                const todoText = todoInput.value.trim();
                if (todoText) {
                    todos.push({ task: todoText });
                    localStorage.setItem('todos', JSON.stringify(todos));
                    renderTodos();
                    todoInput.value = '';
                }
            });

            todoList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-todo-btn') || event.target.closest('.delete-todo-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-todo-btn').dataset.index;
                    if (confirm("Are you sure you want to delete this to-do item?")) {
                        todos.splice(index, 1);
                        localStorage.setItem('todos', JSON.stringify(todos));
                        renderTodos();
                    }
                }
            });

            // --- Timetable Functionality ---
            const timetableTableBody = document.querySelector('.timetable-table tbody');
            const saveTimetableBtn = document.getElementById('saveTimetableBtn');

            function createTimeTable() {
                const times = ["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"];
                const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

                times.forEach(time => {
                    const row = document.createElement('tr');
                    const timeCell = document.createElement('td');
                    timeCell.textContent = time;
                    timeCell.contentEditable = "true";
                    row.appendChild(timeCell);

                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.contentEditable = true;
                        cell.dataset.day = day;
                        cell.dataset.time = time;
                        row.appendChild(cell);
                    });
                    timetableTableBody.appendChild(row);
                });
            }

            function loadTimetable() {
                const savedTimetable = JSON.parse(localStorage.getItem('timetable'));
                if (savedTimetable) {
                    timetableTableBody.innerHTML = ''; // Clear table
                    savedTimetable.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(cellData => {
                            const td = document.createElement('td');
                            td.textContent = cellData.content;
                            td.contentEditable = true;
                            td.dataset.day = cellData.day;
                            td.dataset.time = cellData.time;
                            tr.appendChild(td);
                        });
                        timetableTableBody.appendChild(tr);
                    });
                } else {
                    createTimeTable();
                }
            }

            saveTimetableBtn.addEventListener('click', () => {
                const timetableData = [];
                const rows = document.querySelectorAll('.timetable-table tbody tr');
                rows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        rowData.push({
                            content: cell.textContent,
                            day: cell.dataset.day,
                            time: cell.dataset.time
                        });
                    });
                    timetableData.push(rowData);
                });
                localStorage.setItem('timetable', JSON.stringify(timetableData));
                alert('Timetable saved!');
            });

            // --- Homework Section ---
            const homeworkInput = document.getElementById('homeworkInput');
            const homeworkDueDateInput = document.getElementById('homeworkDueDate');
            const addHomeworkItemBtn = document.getElementById('addHomeworkItemBtn');
            const homeworkList = document.getElementById('homeworkList');

            let homeworks = JSON.parse(localStorage.getItem('homeworks')) || [];

            function renderHomeworks() {
                if (homeworks.length === 0) {
                    homeworkList.innerHTML = '<p class="placeholder-text">No homework assigned yet.</p>';
                    return;
                }

                homeworkList.innerHTML = '';
                homeworks.forEach((hw, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${hw.task} (Due: ${hw.dueDate})</span>
                        <div class="actions">
                            <button class="delete-homework-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    homeworkList.appendChild(li);
                });
            }

            addHomeworkItemBtn.addEventListener('click', () => {
                const task = homeworkInput.value.trim();
                const dueDate = homeworkDueDateInput.value;
                if (task && dueDate) {
                    homeworks.push({ task, dueDate });
                    localStorage.setItem('homeworks', JSON.stringify(homeworks));
                    renderHomeworks();
                    homeworkInput.value = '';
                    homeworkDueDateInput.value = '';
                } else {
                    alert("Please enter both a task and a due date.");
                }
            });

            homeworkList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-homework-btn') || event.target.closest('.delete-homework-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-homework-btn').dataset.index;
                    if (confirm("Are you sure you want to delete this homework item?")) {
                        homeworks.splice(index, 1);
                        localStorage.setItem('homeworks', JSON.stringify(homeworks));
                        renderHomeworks();
                    }
                }
            });

            // --- Links Section ---
            const linkNameInput = document.getElementById('linkNameInput');
            const linkUrlInput = document.getElementById('linkUrlInput');
            const addLinkItemBtn = document.getElementById('addLinkItemBtn');
            const linksList = document.getElementById('linksList');

            let links = JSON.parse(localStorage.getItem('links')) || [];

            function renderLinks() {
                if (links.length === 0) {
                    linksList.innerHTML = '<p class="placeholder-text">No links saved yet.</p>';
                    return;
                }

                linksList.innerHTML = '';
                links.forEach((link, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="${link.url}" target="_blank">${link.name}</a>
                        <div class="actions">
                            <button class="delete-link-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    linksList.appendChild(li);
                });
            }

            addLinkItemBtn.addEventListener('click', () => {
                const name = linkNameInput.value.trim();
                const url = linkUrlInput.value.trim();
                if (name && url) {
                    links.push({ name, url });
                    localStorage.setItem('links', JSON.stringify(links));
                    renderLinks();
                    linkNameInput.value = '';
                    linkUrlInput.value = '';
                } else {
                    alert("Please enter both a name and a URL.");
                }
            });

            linksList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-link-btn') || event.target.closest('.delete-link-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-link-btn').dataset.index;
                    if (confirm("Are you sure you want to delete this link?")) {
                        links.splice(index, 1);
                        localStorage.setItem('links', JSON.stringify(links));
                        renderLinks();
                    }
                }
            });

            // --- Pomodoro Timer Functionality ---
            const pomodoroTimerDisplay = document.getElementById('pomodoroTimerDisplay');
            const pomodoroStatus = document.getElementById('pomodoroStatus');
            const startTimerBtn = document.getElementById('startTimerBtn');
            const pauseTimerBtn = document.getElementById('pauseTimerBtn');
            const resetTimerBtn = document.getElementById('resetTimerBtn');
            const workTimeInput = document.getElementById('workTime');
            const breakTimeInput = document.getElementById('breakTime');

            let countdown;
            let isWorking = true;
            let isPaused = false;
            let timeLeft;

            function startTimer() {
                if (isPaused) {
                    isPaused = false;
                    countdown = setInterval(updateTimer, 1000);
                    startTimerBtn.textContent = 'Continue';
                    startTimerBtn.classList.add('hidden');
                    pauseTimerBtn.classList.remove('hidden');
                    return;
                }

                const workDuration = parseInt(workTimeInput.value) * 60;
                const breakDuration = parseInt(breakTimeInput.value) * 60;

                timeLeft = isWorking ? workDuration : breakDuration;

                clearInterval(countdown);
                countdown = setInterval(updateTimer, 1000);

                startTimerBtn.classList.add('hidden');
                pauseTimerBtn.classList.remove('hidden');
            }

            function updateTimer() {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(countdown);
                    isWorking = !isWorking;
                    pomodoroStatus.textContent = isWorking ? 'Work Session' : 'Break Session';
                    alert(`Time's up! Starting your ${isWorking ? 'work' : 'break'} session now.`);
                    startTimer();
                } else {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    pomodoroTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            function pauseTimer() {
                isPaused = true;
                clearInterval(countdown);
                startTimerBtn.textContent = 'Continue';
                startTimerBtn.classList.remove('hidden');
                pauseTimerBtn.classList.add('hidden');
            }

            function resetTimer() {
                clearInterval(countdown);
                isWorking = true;
                isPaused = false;
                timeLeft = parseInt(workTimeInput.value) * 60;
                pomodoroTimerDisplay.textContent = `${workTimeInput.value.padStart(2, '0')}:00`;
                pomodoroStatus.textContent = 'Work Session';
                startTimerBtn.textContent = 'Start';
                startTimerBtn.classList.remove('hidden');
                pauseTimerBtn.classList.add('hidden');
            }

            // --- Backup & Restore Functionality ---
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importFileInput = document.getElementById('importFileInput');
            const importDataBtn = document.getElementById('importDataBtn');

            exportDataBtn.addEventListener('click', () => {
                const allData = {
                    allNotes: JSON.parse(localStorage.getItem('allNotes')) || [],
                    todos: JSON.parse(localStorage.getItem('todos')) || [],
                    timetable: JSON.parse(localStorage.getItem('timetable')) || [],
                    homeworks: JSON.parse(localStorage.getItem('homeworks')) || [],
                    links: JSON.parse(localStorage.getItem('links')) || [],
                    pdfs: JSON.parse(localStorage.getItem('pdfs')) || [],
                };
                const dataStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'study-hub-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('All data exported successfully!');
            });

            importDataBtn.addEventListener('click', () => {
                const file = importFileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (confirm("Are you sure you want to import this data? This will overwrite your current data!")) {
                                localStorage.setItem('allNotes', JSON.stringify(importedData.allNotes || []));
                                localStorage.setItem('todos', JSON.stringify(importedData.todos || []));
                                localStorage.setItem('timetable', JSON.stringify(importedData.timetable || []));
                                localStorage.setItem('homeworks', JSON.stringify(importedData.homeworks || []));
                                localStorage.setItem('links', JSON.stringify(importedData.links || []));
                                localStorage.setItem('pdfs', JSON.stringify(importedData.pdfs || []));
                                reloadAllData();
                                alert('All data imported successfully!');
                            }
                        } catch (error) {
                            alert('Failed to parse JSON file. Please make sure the file is a valid backup file.');
                        }
                    };
                    reader.readAsText(file);
                } else {
                    alert('Please select a JSON file to import.');
                }
            });

            // Initialize the app
            renderNotesList();
            if (activeNoteId) {
                loadNoteIntoEditor(activeNoteId);
            } else if (allNotes.length > 0) {
                loadNoteIntoEditor(allNotes[0].id);
            } else {
                editor.setContents([{ insert: 'Welcome to your Study Hub Notes! Click "New Note" to create one!' }]);
                currentNoteTitleDisplay.textContent = 'Not Loaded';
            }

            renderPdfs();
            renderTodos();
            loadTimetable();
            renderHomeworks();
            renderLinks();
            
            renderPdfViewer();
        });
    </script>
</body>
</html>

